<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¢ç¢¼æ¯”å°å°å·¥å…·</title>
    <!-- å¼•å…¥ html5-qrcode æƒç¢¼å¥—ä»¶ -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }
        .card {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .title {
            text-align: center;
            margin-top: 0;
            color: #333;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
            margin-bottom: 10px;
            background-color: #fafafa;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        button {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-scan { background-color: #0d6efd; color: white; }
        .btn-clear { background-color: #6c757d; color: white; }
        .btn-clear-all { background-color: #dc3545; color: white; }
        .btn-compare { background-color: #198754; color: white; }
        
        /* æƒæå€å¡Š */
        #scanner-container {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #reader { width: 100%; max-width: 500px; }
        .btn-cancel-scan {
            margin-top: 20px;
            background-color: #dc3545;
            color: white;
            width: 80%;
            max-width: 300px;
        }

        /* å½ˆå‡ºè¦–çª— Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 85%;
            max-width: 400px;
            text-align: center;
            font-size: 18px;
            line-height: 1.6;
        }
        .modal-content p { margin: 10px 0; word-break: break-all; }
        .result-text { font-size: 24px; font-weight: bold; margin-top: 15px; }
        .match { color: #198754; }
        .mismatch { color: #dc3545; }
        
        .mode-selector {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 8px;
        }
        .mode-selector label { font-weight: normal; margin: 0; }
    </style>
</head>
<body>

    <h2 class="title">æ¢ç¢¼æ¯”å°å°å·¥å…·</h2>

    <!-- æ¨¡å¼é¸æ“‡ -->
    <div class="card">
        <label>æ¯”å°æ¨¡å¼ï¼š</label>
        <div class="mode-selector">
            <label><input type="radio" name="compareMode" value="auto" checked> è‡ªå‹•æ¯”å°</label>
            <label><input type="radio" name="compareMode" value="manual"> æ‰‹å‹•é»é¸æ¯”å°</label>
        </div>
    </div>

    <!-- æ¬„ä½ A -->
    <div class="card">
        <label>A æ¬„ä½</label>
        <input type="text" id="fieldA" placeholder="é»æ“Šæƒææˆ–æ‰‹å‹•è¼¸å…¥" onclick="startScan('A')" readonly>
        <div class="button-group">
            <button class="btn-scan" onclick="startScan('A')">ğŸ“· æƒæ A</button>
            <button class="btn-clear" onclick="clearField('A')">æ¸…é™¤ A</button>
        </div>
    </div>

    <!-- æ¬„ä½ B -->
    <div class="card">
        <label>B æ¬„ä½</label>
        <input type="text" id="fieldB" placeholder="é»æ“Šæƒææˆ–æ‰‹å‹•è¼¸å…¥" onclick="startScan('B')" readonly>
        <div class="button-group">
            <button class="btn-scan" onclick="startScan('B')">ğŸ“· æƒæ B</button>
            <button class="btn-clear" onclick="clearField('B')">æ¸…é™¤ B</button>
        </div>
    </div>

    <!-- å…¨åŸŸæ“ä½œ -->
    <div class="card">
        <div class="button-group">
            <button class="btn-clear-all" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨ (Aèˆ‡B)</button>
            <button class="btn-compare" onclick="manualCompare()">ğŸ” æ‰‹å‹•æ¯”å°</button>
        </div>
    </div>

    <!-- æƒæç›¸æ©Ÿä»‹é¢ -->
    <div id="scanner-container">
        <div id="reader"></div>
        <button class="btn-cancel-scan" onclick="stopScan()">å–æ¶ˆæƒæ</button>
    </div>

    <!-- æ¯”å°çµæœå½ˆå‡ºè¦–çª— -->
    <div id="resultModal" class="modal">
        <div class="modal-content">
            <p><strong>ç¬¬ä¸€åˆ— (Aæ¬„ä½)</strong><br><span id="modalValA"></span></p>
            <p><strong>ç¬¬äºŒåˆ— (Bæ¬„ä½)</strong><br><span id="modalValB"></span></p>
            <hr>
            <p id="modalResult" class="result-text"></p>
            <button class="btn-clear" style="width: 100%; margin-top: 15px;" onclick="closeModal()">é—œé–‰</button>
        </div>
    </div>

    <script>
        let html5QrCode;
        let currentTarget = null;

        // â˜…â˜…â˜… æ ¸å¿ƒï¼šå–å‡ºæ¢ç¢¼ä¸­ç‰¹å®šå€æ®µçš„æ–‡å­— â˜…â˜…â˜…
        function extractSpecificText(rawText) {
            // ä½ å¯ä»¥åœ¨é€™è£¡æ’°å¯«ä½ è¦æ“·å–ç‰¹å®šå­—ä¸²çš„é‚è¼¯
            // ç¯„ä¾‹ 1: åªå–å‰ 10 å€‹å­—å…ƒ
            // return rawText.substring(0, 10);
            
            // ç¯„ä¾‹ 2: ä½¿ç”¨æ­£è¦è¡¨é”å¼å–å‡ºæ•¸å­—
            // const match = rawText.match(/\d+/);
            // return match ? match[0] : rawText;

            // é è¨­ï¼šä¸æ“·å–ï¼Œç›´æ¥å›å‚³æƒæåˆ°çš„å®Œæ•´æ–‡å­—
            return rawText; 
        }

        // å•Ÿå‹•ç›¸æ©Ÿæƒæ
        function startScan(target) {
            currentTarget = target;
            document.getElementById('scanner-container').style.display = 'flex';

            if (!html5QrCode) {
                html5QrCode = new Html5Qrcode("reader");
            }
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            // é–‹å•Ÿå¾Œç½®é¡é ­
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("å•Ÿå‹•ç›¸æ©Ÿå¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦å·²æˆäºˆç›¸æ©Ÿæ¬Šé™ï¼š" + err);
                stopScan();
            });
        }

        // åœæ­¢æƒæ
        function stopScan() {
            document.getElementById('scanner-container').style.display = 'none';
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(ignore => {}).catch(err => {});
            }
        }

        // æƒææˆåŠŸçš„å›èª¿å‡½æ•¸
        function onScanSuccess(decodedText, decodedResult) {
            // éœ‡å‹•å›é¥‹ (å¦‚æœè£ç½®æ”¯æ´)
            if (navigator.vibrate) navigator.vibrate(200);
            
            stopScan(); // åœæ­¢ç›¸æ©Ÿ
            
            // å‘¼å«å‡½å¼æ“·å–ç‰¹å®šå€æ®µ
            const extractedText = extractSpecificText(decodedText);
            
            // å¡«å…¥å°æ‡‰çš„æ¬„ä½
            if (currentTarget === 'A') {
                document.getElementById('fieldA').value = extractedText;
            } else if (currentTarget === 'B') {
                document.getElementById('fieldB').value = extractedText;
            }
            
            // æª¢æŸ¥æ˜¯å¦éœ€è¦è‡ªå‹•æ¯”å°
            checkAutoCompare();
        }

        // æ¸…é™¤å–®ä¸€æ¬„ä½
        function clearField(target) {
            if (target === 'A') document.getElementById('fieldA').value = '';
            if (target === 'B') document.getElementById('fieldB').value = '';
        }

        // æ¸…é™¤å…¨éƒ¨æ¬„ä½
        function clearAll() {
            clearField('A');
            clearField('B');
        }

        // åˆ¤æ–·æ˜¯å¦ç‚ºè‡ªå‹•æ¯”å°
        function checkAutoCompare() {
            const mode = document.querySelector('input[name="compareMode"]:checked').value;
            const valA = document.getElementById('fieldA').value;
            const valB = document.getElementById('fieldB').value;

            // å¦‚æœè¨­å®šç‚ºè‡ªå‹•æ¯”å°ï¼Œä¸”å…©å€‹æ¬„ä½éƒ½æœ‰å€¼ï¼Œå°±ç›´æ¥æ¯”å°
            if (mode === 'auto' && valA !== '' && valB !== '') {
                showCompareResult(valA, valB);
            }
        }

        // æ‰‹å‹•æ¯”å°æŒ‰éˆ•è§¸ç™¼
        function manualCompare() {
            const valA = document.getElementById('fieldA').value;
            const valB = document.getElementById('fieldB').value;

            if (valA === '' || valB === '') {
                alert("è«‹ç¢ºèª A æ¬„ä½èˆ‡ B æ¬„ä½çš†å·²å–å¾—æ¢ç¢¼å…§å®¹ï¼");
                return;
            }
            showCompareResult(valA, valB);
        }

        // é¡¯ç¤ºæ¯”å°çµæœçš„å½ˆå‡ºè¦–çª—
        function showCompareResult(valA, valB) {
            const isMatch = (valA === valB);
            
            document.getElementById('modalValA').innerText = valA;
            document.getElementById('modalValB').innerText = valB;
            
            const resultElement = document.getElementById('modalResult');
            if (isMatch) {
                resultElement.innerText = "âœ… æ¯”å°æˆåŠŸ (ç›¸ç¬¦)";
                resultElement.className = "result-text match";
            } else {
                resultElement.innerText = "âŒ æ¯”å°å¤±æ•— (ä¸ç›¸ç¬¦)";
                resultElement.className = "result-text mismatch";
            }

            // é¡¯ç¤º Modal
            document.getElementById('resultModal').style.display = 'flex';
        }

        // é—œé–‰å½ˆå‡ºè¦–çª—
        function closeModal() {
            document.getElementById('resultModal').style.display = 'none';
        }
    </script>
</body>
</html>
