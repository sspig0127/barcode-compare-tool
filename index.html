<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¢ç¢¼æ¯”å°å·¥å…·</title>
  
  <!-- è¼‰å…¥é›™å¼•æ“ SDK -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.12.1/dist/quagga.min.js"></script>
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      margin: 0; padding: 15px; box-sizing: border-box;
    }
    .header {
      display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 15px;
    }
    .title { margin: 0; color: #333; font-size: 22px; }
    .lang-select {
      padding: 5px 10px; border-radius: 5px;
      border: 1px solid #ccc; font-size: 14px; background: #fff;
    }
    .card {
      background: #fff; padding: 15px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px;
    }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input[type="text"] {
      width: 100%; padding: 12px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 6px;
      box-sizing: border-box; margin-bottom: 10px;
      background-color: #fafafa; outline: none;
    }
    input[type="text"]:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 5px rgba(13, 110, 253, 0.3);
    }
    .button-group { display: flex; gap: 10px; margin-bottom: 10px; }
    button {
      flex: 1; padding: 12px; font-size: 16px;
      border: none; border-radius: 6px; cursor: pointer; font-weight: bold;
    }
    .btn-scan      { background-color: #0d6efd; color: white; }
    .btn-clear     { background-color: #6c757d; color: white; }
    .btn-clear-all { background-color: #dc3545; color: white; }
    .btn-compare   { background-color: #198754; color: white; }

    /* â”€â”€ æƒæå™¨è¦†è“‹å±¤ â”€â”€ */
    #scanner-container {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 1000;
      flex-direction: column;
      align-items: center;
      padding: 8px 10px;
      padding-top:    calc(8px + env(safe-area-inset-top,    0px));
      padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
      box-sizing: border-box;
    }

    /* é ‚éƒ¨æ“ä½œåˆ— (é¡é ­é¸å–® + æ‰‹é›»ç­’) */
    .top-controls-wrap {
      flex-shrink: 0;
      width: 100%;
      max-width: 520px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .camera-selector-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .camera-selector-wrap label {
      color: #fff; font-size: 14px;
      white-space: nowrap; margin: 0; font-weight: normal;
    }
    #cameraSelect {
      flex: 1; padding: 8px 10px; font-size: 14px;
      border-radius: 6px; border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.12); color: #fff;
    }
    #cameraSelect option   { color: #333; background: #fff; }
    #cameraSelect:disabled { opacity: 0.6; }

    /* â˜… æ‰‹é›»ç­’æŒ‰éˆ•èˆ‡éŒ¯èª¤å‹•ç•« */
    #btn-torch {
      display: none; 
      flex-shrink: 0;
      padding: 8px 14px;
      font-size: 18px;
      border-radius: 6px;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.4);
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    #btn-torch.active {
      background: #ffc107;
      color: #000;
      border-color: #ffc107;
    }
    @keyframes shake {
      0%   { transform: translateX(0); }
      25%  { transform: translateX(-4px); }
      50%  { transform: translateX(4px); }
      75%  { transform: translateX(-4px); }
      100% { transform: translateX(0); }
    }
    .error-shake {
      animation: shake 0.3s;
      background: #dc3545 !important; 
      border-color: #dc3545 !important;
    }

    /* 1D / 2D åˆ‡æ›æŒ‰éˆ• */
    .scan-mode-wrap {
      flex-shrink: 0;
      width: 100%;
      max-width: 520px;
      display: flex;
      gap: 6px;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.08);
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    .btn-mode {
      flex: 1 1 0;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: bold;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(255,255,255,0.75);
      cursor: pointer;
      line-height: 1.1;
      transition: background 0.2s, color 0.2s;
    }
    .btn-mode.active {
      background: #ffffff;
      color: #1a1a1a;
      border-color: #ffffff;
    }

    /* é›™å¼•æ“å®¹å™¨ */
    #reader-wrap {
      width: 100%;
      max-width: 520px;
      flex: 1;
      min-height: 0;
      position: relative;
      overflow: hidden;
      border-radius: 10px;
      background: #000;
    }
    #html5qr-reader, #quagga-reader {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }
    #quagga-reader video, #quagga-reader canvas {
      width: 100%; height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0; left: 0;
    }

    /* è‡ªè£½è¼”åŠ© UI æ¡† */
    #scanGuide {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      box-sizing: border-box;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      filter: drop-shadow(0 0 6px rgba(0,0,0,0.35));
      z-index: 10;
    }
    #scanGuide.mode-2d {
      width: min(72%, 340px);
      aspect-ratio: 1 / 1;
      height: auto;
    }
    #scanGuide.mode-1d {
      width: min(90%, 460px);
      height: clamp(110px, 20vh, 160px);
      border-radius: 10px;
    }

    /* å››è§’é»ç¶´ */
    .corner {
      position: absolute;
      width: 26px; height: 26px;
      box-sizing: border-box;
      border: 4px solid rgba(0, 229, 255, 0.9);
      filter: drop-shadow(0 0 6px rgba(0,229,255,0.18));
    }
    .corner.tl { left: -2px; top: -2px; border-right: 0; border-bottom: 0; border-top-left-radius: 10px; }
    .corner.tr { right: -2px; top: -2px; border-left: 0; border-bottom: 0; border-top-right-radius: 10px; }
    .corner.bl { left: -2px; bottom: -2px; border-right: 0; border-top: 0; border-bottom-left-radius: 10px; }
    .corner.br { right: -2px; bottom: -2px; border-left: 0; border-top: 0; border-bottom-right-radius: 10px; }

    /* 1D æƒæç·š */
    .scan-line {
      position: absolute;
      left: 10px; right: 10px;
      top: 50%; height: 2px;
      background: rgba(255, 70, 70, 0.85);
      box-shadow: 0 0 10px rgba(255, 70, 70, 0.35);
      transform: translateY(-50%);
      display: none;
    }
    #scanGuide.mode-1d .scan-line { display: block; }

    /* å–æ¶ˆæŒ‰éˆ• */
    .btn-cancel-scan {
      flex-shrink: 0;
      margin-top: 10px; margin-bottom: 4px;
      background-color: #dc3545; color: white;
      width: auto; padding: 8px 22px; font-size: 14px;
    }

    /* â”€â”€ çµæœ Modal â”€â”€ */
    .modal {
      display: none; position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 2000;
      justify-content: center; align-items: center;
    }
    .modal-content {
      background: white; padding: 20px; border-radius: 10px;
      width: 85%; max-width: 400px;
      text-align: center; font-size: 18px; line-height: 1.6;
    }
    .modal-content p { margin: 10px 0; word-break: break-all; }
    .result-text { font-size: 24px; font-weight: bold; margin-top: 15px; }
    .match    { color: #198754; }
    .mismatch { color: #dc3545; }

    .mode-selector {
      display: flex; justify-content: space-around;
      margin-bottom: 15px; padding: 10px;
      background: #e9ecef; border-radius: 8px;
    }
    .mode-selector label { font-weight: normal; margin: 0; font-size: 15px; }
  </style>
</head>
<body>

  <div class="header">
    <h2 class="title" id="ui-title">æ¢ç¢¼æ¯”å°å·¥å…·</h2>
    <select class="lang-select" id="langSelector" onchange="changeLanguage()">
      <option value="zh-TW" selected>ç¹é«”ä¸­æ–‡</option>
      <option value="en">English</option>
      <option value="vi">Tiáº¿ng Viá»‡t</option>
    </select>
  </div>

  <div class="card">
    <label id="ui-mode-label">æ¯”å°æ¨¡å¼ï¼š</label>
    <div class="mode-selector">
      <label>
        <input type="radio" name="compareMode" value="auto" checked>
        <span id="ui-mode-auto">è‡ªå‹•æ¯”å°</span>
      </label>
      <label>
        <input type="radio" name="compareMode" value="manual">
        <span id="ui-mode-manual">æ‰‹å‹•é»é¸</span>
      </label>
    </div>
  </div>

  <div class="card">
    <label id="ui-field-a-label">A æ¬„ä½</label>
    <input type="text" id="fieldA" placeholder="" oninput="checkAutoCompare()">
    <div class="button-group">
      <button class="btn-scan"  id="ui-btn-scan-a"  onclick="startScan('A')">ğŸ“· æƒæ A</button>
      <button class="btn-clear" id="ui-btn-clear-a" onclick="clearField('A')">æ¸…é™¤ A</button>
    </div>
  </div>

  <div class="card">
    <label id="ui-field-b-label">B æ¬„ä½</label>
    <input type="text" id="fieldB" placeholder="" oninput="checkAutoCompare()">
    <div class="button-group">
      <button class="btn-scan"  id="ui-btn-scan-b"  onclick="startScan('B')">ğŸ“· æƒæ B</button>
      <button class="btn-clear" id="ui-btn-clear-b" onclick="clearField('B')">æ¸…é™¤ B</button>
    </div>
  </div>

  <div class="card">
    <div class="button-group">
      <button class="btn-clear-all" id="ui-btn-clear-all" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨</button>
      <button class="btn-compare"   id="ui-btn-compare"   onclick="manualCompare()">ğŸ” åŸ·è¡Œæ¯”å°</button>
    </div>
  </div>

  <div id="scanner-container">
    
    <!-- é ‚éƒ¨æ“ä½œåˆ— -->
    <div class="top-controls-wrap">
      <div class="camera-selector-wrap">
        <label id="ui-camera-label">åˆ‡æ›é¡é ­ï¼š</label>
        <select id="cameraSelect" onchange="switchCamera(this.value)" disabled>
          <option id="ui-camera-loading-opt">è¼‰å…¥é¡é ­æ¸…å–®...</option>
        </select>
      </div>
      <!-- â˜… æ‰‹é›»ç­’æŒ‰éˆ• -->
      <button id="btn-torch" onclick="toggleTorch()" title="é–‹é—œæ‰‹é›»ç­’">ğŸ”¦</button>
    </div>

    <!-- 1D / 2D é›™å¼•æ“åˆ‡æ› -->
    <div class="scan-mode-wrap" role="group" aria-label="Scan mode">
      <button class="btn-mode active" id="btn-mode-1d" onclick="setScanMode('1D')" type="button">
        <span id="ui-btn-mode-1d">1D æ¢ç¢¼</span>
      </button>
      <button class="btn-mode" id="btn-mode-2d" onclick="setScanMode('2D')" type="button">
        <span id="ui-btn-mode-2d">2D / QR Code</span>
      </button>
    </div>

    <div id="reader-wrap">
      <!-- Html5-qrcode å®¹å™¨ (2D) -->
      <div id="html5qr-reader" style="display:none;"></div>
      <!-- Quagga2 å®¹å™¨ (1D) -->
      <div id="quagga-reader" style="display:none;"></div>

      <!-- è¼”åŠ©æ¡† UI -->
      <div id="scanGuide" class="mode-1d" aria-hidden="true">
        <span class="corner tl"></span>
        <span class="corner tr"></span>
        <span class="corner bl"></span>
        <span class="corner br"></span>
        <div class="scan-line"></div>
      </div>
    </div>

    <button class="btn-cancel-scan" id="ui-btn-cancel-scan" onclick="stopScan()">å–æ¶ˆæƒæ</button>
  </div>

  <div id="resultModal" class="modal">
    <div class="modal-content">
      <p><strong id="ui-modal-row1">ç¬¬ä¸€åˆ— (Aæ¬„ä½)</strong><br><span id="modalValA"></span></p>
      <p><strong id="ui-modal-row2">ç¬¬äºŒåˆ— (Bæ¬„ä½)</strong><br><span id="modalValB"></span></p>
      <hr>
      <p id="modalResult" class="result-text"></p>
      <button class="btn-clear" id="ui-modal-close"
              style="width:100%;margin-top:15px" onclick="closeModal()">é—œé–‰</button>
    </div>
  </div>

  <script>
    // â”€â”€ ç³»çµ±å…¨åŸŸè®Šæ•¸ â”€â”€
    let html5QrCode       = null;
    let isHtml5QrScanning = false;
    let isQuaggaScanning  = false;
    
    // é˜²æŠ–æ©Ÿåˆ¶è®Šæ•¸ (Quagga å°ˆç”¨)
    let quaggaLastCode    = "";
    let quaggaCodeCount   = 0;
    const REQUIRED_MATCHES = 2; 

    let currentTarget     = null;
    let currentLang       = 'zh-TW';
    let cameras           = [];
    let scanMode          = '1D'; 
    let currentCameraId   = null;
    let isTorchOn         = false;

    // â”€â”€ i18n ç¿»è­¯è¡¨ â”€â”€
    const translations = {
      'zh-TW': {
        title         : 'æ¢ç¢¼æ¯”å°å·¥å…·',
        modeLabel     : 'æ¯”å°æ¨¡å¼ï¼š',
        modeAuto      : 'è‡ªå‹•æ¯”å°',
        modeManual    : 'æ‰‹å‹•é»é¸',
        fieldALabel   : 'A æ¬„ä½',
        fieldBLabel   : 'B æ¬„ä½',
        placeholder   : 'æ‰‹å‹•è¼¸å…¥æˆ–é»ä¸‹æ–¹æƒæ',
        btnScanA      : 'ğŸ“· æƒæ A',
        btnScanB      : 'ğŸ“· æƒæ B',
        btnClearA     : 'æ¸…é™¤ A',
        btnClearB     : 'æ¸…é™¤ B',
        btnClearAll   : 'ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨',
        btnCompare    : 'ğŸ” åŸ·è¡Œæ¯”å°',
        btnCancelScan : 'å–æ¶ˆæƒæ',
        modalRow1     : 'ç¬¬ä¸€åˆ— (Aæ¬„ä½)',
        modalRow2     : 'ç¬¬äºŒåˆ— (Bæ¬„ä½)',
        modalClose    : 'é—œé–‰',
        matchSuccess  : 'âœ… æ¯”å°æˆåŠŸ',
        matchFail     : 'âŒ æ¯”å°å¤±æ•—',
        alertEmpty    : 'è«‹ç¢ºä¿ Aã€B å…©æ¬„ä½éƒ½æœ‰æ¢ç¢¼è³‡æ–™ï¼',
        alertCamFail  : 'é¡é ­å•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªç›¸æ©Ÿæ¬Šé™ã€‚',
        cameraLabel   : 'åˆ‡æ›é¡é ­ï¼š',
        cameraLoading : 'è¼‰å…¥é¡é ­æ¸…å–®...',
        cameraDefault : 'é¡é ­',
        alertCamSwitch: 'åˆ‡æ›é¡é ­å¤±æ•—ï¼š',
        btnMode1D     : '1D æ¢ç¢¼ (Quagga)',
        btnMode2D     : '2D / QR Code',
      },
      'en': {
        title         : 'Barcode Matcher',
        modeLabel     : 'Mode:',
        modeAuto      : 'Auto Match',
        modeManual    : 'Manual',
        fieldALabel   : 'Field A',
        fieldBLabel   : 'Field B',
        placeholder   : 'Type manually or tap scan below',
        btnScanA      : 'ğŸ“· Scan A',
        btnScanB      : 'ğŸ“· Scan B',
        btnClearA     : 'Clear A',
        btnClearB     : 'Clear B',
        btnClearAll   : 'ğŸ—‘ï¸ Clear All',
        btnCompare    : 'ğŸ” Compare',
        btnCancelScan : 'Cancel Scan',
        modalRow1     : 'Row 1 (Field A)',
        modalRow2     : 'Row 2 (Field B)',
        modalClose    : 'Close',
        matchSuccess  : 'âœ… Match â€” Success',
        matchFail     : 'âŒ Mismatch â€” Fail',
        alertEmpty    : 'Please ensure both fields have barcode data!',
        alertCamFail  : 'Camera failed. Check permissions.',
        cameraLabel   : 'Switch Camera:',
        cameraLoading : 'Loading cameras...',
        cameraDefault : 'Camera',
        alertCamSwitch: 'Camera switch failed: ',
        btnMode1D     : '1D Barcode',
        btnMode2D     : '2D / QR Code',
      },
      'vi': {
        title         : 'CÃ´ng cá»¥ so sÃ¡nh mÃ£ váº¡ch',
        modeLabel     : 'Cháº¿ Ä‘á»™:',
        modeAuto      : 'Tá»± Ä‘á»™ng',
        modeManual    : 'Thá»§ cÃ´ng',
        fieldALabel   : 'TrÆ°á»ng A',
        fieldBLabel   : 'TrÆ°á»ng B',
        placeholder   : 'Nháº­p thá»§ cÃ´ng hoáº·c nháº¥n quÃ©t',
        btnScanA      : 'ğŸ“· QuÃ©t A',
        btnScanB      : 'ğŸ“· QuÃ©t B',
        btnClearA     : 'XÃ³a A',
        btnClearB     : 'XÃ³a B',
        btnClearAll   : 'ğŸ—‘ï¸ XÃ³a táº¥t cáº£',
        btnCompare    : 'ğŸ” So sÃ¡nh',
        btnCancelScan : 'Há»§y quÃ©t',
        modalRow1     : 'HÃ ng 1 (TrÆ°á»ng A)',
        modalRow2     : 'HÃ ng 2 (TrÆ°á»ng B)',
        modalClose    : 'ÄÃ³ng',
        matchSuccess  : 'âœ… Khá»›p â€” ThÃ nh cÃ´ng',
        matchFail     : 'âŒ KhÃ´ng khá»›p â€” Tháº¥t báº¡i',
        alertEmpty    : 'Vui lÃ²ng Ä‘áº£m báº£o cáº£ hai trÆ°á»ng Ä‘á»u cÃ³ dá»¯ liá»‡u!',
        alertCamFail  : 'Lá»—i mÃ¡y áº£nh. Kiá»ƒm tra quyá»n.',
        cameraLabel   : 'Chuyá»ƒn camera:',
        cameraLoading : 'Äang táº£i camera...',
        cameraDefault : 'Camera',
        alertCamSwitch: 'Chuyá»ƒn camera tháº¥t báº¡i: ',
        btnMode1D     : '1D MÃ£ váº¡ch',
        btnMode2D     : '2D / QR Code',
      }
    };

    function applyScanModeUI() {
      document.getElementById('btn-mode-1d').classList.toggle('active', scanMode === '1D');
      document.getElementById('btn-mode-2d').classList.toggle('active', scanMode === '2D');

      const guide = document.getElementById('scanGuide');
      guide.classList.toggle('mode-1d', scanMode === '1D');
      guide.classList.toggle('mode-2d', scanMode === '2D');
    }

    function changeLanguage() {
      currentLang = document.getElementById('langSelector').value;
      const t = translations[currentLang];
      document.getElementById('ui-title').innerText            = t.title;
      document.getElementById('ui-mode-label').innerText       = t.modeLabel;
      document.getElementById('ui-mode-auto').innerText        = t.modeAuto;
      document.getElementById('ui-mode-manual').innerText      = t.modeManual;
      document.getElementById('ui-field-a-label').innerText    = t.fieldALabel;
      document.getElementById('ui-field-b-label').innerText    = t.fieldBLabel;
      document.getElementById('fieldA').placeholder            = t.placeholder;
      document.getElementById('fieldB').placeholder            = t.placeholder;
      document.getElementById('ui-btn-scan-a').innerText       = t.btnScanA;
      document.getElementById('ui-btn-scan-b').innerText       = t.btnScanB;
      document.getElementById('ui-btn-clear-a').innerText      = t.btnClearA;
      document.getElementById('ui-btn-clear-b').innerText      = t.btnClearB;
      document.getElementById('ui-btn-clear-all').innerText    = t.btnClearAll;
      document.getElementById('ui-btn-compare').innerText      = t.btnCompare;
      document.getElementById('ui-btn-cancel-scan').innerText  = t.btnCancelScan;
      document.getElementById('ui-modal-row1').innerText       = t.modalRow1;
      document.getElementById('ui-modal-row2').innerText       = t.modalRow2;
      document.getElementById('ui-modal-close').innerText      = t.modalClose;
      document.getElementById('ui-camera-label').innerText     = t.cameraLabel;
      document.getElementById('ui-btn-mode-1d').innerText      = t.btnMode1D;
      document.getElementById('ui-btn-mode-2d').innerText      = t.btnMode2D;
    }

    // â”€â”€ â˜… æ‰‹é›»ç­’ (Torch) åš´è¬¹æ§åˆ¶èˆ‡éŒ¯èª¤æ•æ‰ â”€â”€
    async function checkTorchCapability(track) {
      const btnTorch = document.getElementById('btn-torch');
      
      if (track && typeof track.getCapabilities === 'function') {
        const capabilities = track.getCapabilities();

        // åˆ¤æ–· torch æ˜¯å¦æ”¯æ´ (éƒ¨åˆ† Android éœ€è¦æª¢æŸ¥ fillLightMode)
        const isTorchSupported = !!capabilities.torch || 
                                 ('fillLightMode' in capabilities && capabilities.fillLightMode.includes('flash'));

        if (isTorchSupported) {
          btnTorch.style.display = 'block';
          
          if (isTorchOn) {
            try {
              await track.applyConstraints({ advanced: [{ torch: true }] });
              btnTorch.classList.add('active');
            } catch(e) { 
              console.warn('Torch restore failed:', e);
              isTorchOn = false;
              btnTorch.classList.remove('active');
            }
          }
          return;
        }
      }
      
      // ä¸æ”¯æ´æ™‚éš±è—
      btnTorch.style.display = 'none';
      isTorchOn = false;
      btnTorch.classList.remove('active');
    }

    async function toggleTorch() {
      let track = null;
      let targetState = !isTorchOn;

      try {
        if (scanMode === '2D' && isHtml5QrScanning) {
          const capabilities = html5QrCode.getRunningTrackCameraCapabilities();
          if (capabilities && capabilities.torchFeature) {
             await capabilities.torchFeature().apply(targetState);
             isTorchOn = targetState;
             document.getElementById('btn-torch').classList.toggle('active', isTorchOn);
             return; 
          } else {
             // Fallback: å®˜æ–¹ API ç„¡æ³•ä½¿ç”¨æ™‚ï¼Œç›´æ¥å°‹æ‰¾ video stream
             const video = document.querySelector('#html5qr-reader video');
             if (video && video.srcObject) {
               track = video.srcObject.getVideoTracks()[0];
             }
          }
        } else if (scanMode === '1D' && isQuaggaScanning) {
          track = Quagga.CameraAccess.getActiveTrack();
        }

        // è‹¥ä¸Šè¿°å–å¾— track æˆåŠŸï¼Œç›´æ¥è§¸ç™¼ applyConstraints
        if (track && typeof track.applyConstraints === 'function') {
           await track.applyConstraints({ advanced: [{ torch: targetState }] });
           isTorchOn = targetState;
           document.getElementById('btn-torch').classList.toggle('active', isTorchOn);
        }

      } catch (err) {
        console.warn('Torch toggle error:', err);
        // è§¸ç™¼éŒ¯èª¤å‹•ç•«æç¤º
        const btn = document.getElementById('btn-torch');
        btn.classList.add('error-shake');
        setTimeout(() => btn.classList.remove('error-shake'), 300);

        // ç‹€æ…‹å›æ»¾ (ç¢ºä¿ UI èˆ‡å¯¦éš›ç¡¬é«”ä¸€è‡´)
        document.getElementById('btn-torch').classList.toggle('active', isTorchOn);
      }
    }

    // â”€â”€ åˆ‡æ› 1D / 2D å¼•æ“è§¸ç™¼å™¨ â”€â”€
    async function setScanMode(mode) {
      if (scanMode === mode) return;
      scanMode = mode;
      applyScanModeUI();
      
      if (document.getElementById('scanner-container').style.display === 'flex') {
        const select = document.getElementById('cameraSelect');
        select.disabled = true;
        document.getElementById('btn-torch').style.display = 'none'; // åˆ‡æ›å¼•æ“ä¸­å…ˆéš±è—
        try {
          if (currentCameraId) {
            await startEngine(currentCameraId);
          } else {
            await startEngineFallback();
          }
        } catch (err) {
          alert(translations[currentLang].alertCamFail + '\n' + err);
          await stopScan();
        } finally {
          select.disabled = false;
        }
      }
    }

    // â”€â”€ å…¨åŸŸåœæ­¢æ‰€æœ‰ç›¸æ©Ÿå¼•æ“ â”€â”€
    async function stopActiveEngines() {
      if (isHtml5QrScanning && html5QrCode) {
        try { await html5QrCode.stop(); } catch (e) { console.warn(e); }
        isHtml5QrScanning = false;
      }
      if (isQuaggaScanning) {
        try { Quagga.stop(); } catch (e) { console.warn(e); }
        isQuaggaScanning = false;
      }
      document.getElementById('btn-torch').style.display = 'none';
    }

    // â”€â”€ å•Ÿå‹•æ ¸å¿ƒå¼•æ“ â”€â”€
    async function startEngine(cameraId) {
      await stopActiveEngines();
      currentCameraId = cameraId;

      document.getElementById('html5qr-reader').style.display = scanMode === '2D' ? 'block' : 'none';
      document.getElementById('quagga-reader').style.display  = scanMode === '1D' ? 'block' : 'none';

      if (scanMode === '2D') {
        if (!html5QrCode) html5QrCode = new Html5Qrcode('html5qr-reader');
        const config = {
          fps: 15,
          useBarCodeDetectorIfSupported: true,
          videoConstraints: {
            deviceId: { exact: cameraId },
            width: { ideal: 1280 },
            height: { ideal: 720 },
            advanced: [{ focusMode: 'continuous' }]
          }
        };
        await html5QrCode.start({ deviceId: { exact: cameraId } }, config, onScanSuccess);
        isHtml5QrScanning = true;
        
        setTimeout(() => {
           const videoTrack = document.querySelector('#html5qr-reader video')?.srcObject?.getVideoTracks()[0];
           if (videoTrack) checkTorchCapability(videoTrack);
        }, 800);

      } else {
        quaggaLastCode = "";
        quaggaCodeCount = 0;
        document.getElementById('quagga-reader').innerHTML = ''; 

        return new Promise((resolve, reject) => {
          Quagga.init({
            inputStream: {
              name: "Live",
              type: "LiveStream",
              target: document.querySelector('#quagga-reader'),
              constraints: {
                deviceId: { exact: cameraId },
                width: { ideal: 1280 },
                height: { ideal: 720 }
              }
            },
            decoder: {
              readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
            },
            locate: true
          }, function(err) {
            if (err) { reject(err); return; }
            Quagga.start();
            isQuaggaScanning = true;
            setTimeout(() => checkTorchCapability(Quagga.CameraAccess.getActiveTrack()), 800);
            resolve();
          });
        });
      }
    }

    // â”€â”€ Fallback å•Ÿå‹• â”€â”€
    async function startEngineFallback() {
      await stopActiveEngines();
      currentCameraId = null;

      document.getElementById('html5qr-reader').style.display = scanMode === '2D' ? 'block' : 'none';
      document.getElementById('quagga-reader').style.display  = scanMode === '1D' ? 'block' : 'none';

      if (scanMode === '2D') {
        if (!html5QrCode) html5QrCode = new Html5Qrcode('html5qr-reader');
        await html5QrCode.start(
          { facingMode: 'environment' },
          { fps: 15, useBarCodeDetectorIfSupported: true },
          onScanSuccess
        );
        isHtml5QrScanning = true;
        setTimeout(() => {
           const videoTrack = document.querySelector('#html5qr-reader video')?.srcObject?.getVideoTracks()[0];
           if (videoTrack) checkTorchCapability(videoTrack);
        }, 800);
      } else {
        quaggaLastCode = ""; quaggaCodeCount = 0;
        document.getElementById('quagga-reader').innerHTML = '';
        return new Promise((resolve, reject) => {
          Quagga.init({
            inputStream: {
              name: "Live", type: "LiveStream",
              target: document.querySelector('#quagga-reader'),
              constraints: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
            },
            decoder: { readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"] },
            locate: true
          }, function(err) {
            if (err) { reject(err); return; }
            Quagga.start();
            isQuaggaScanning = true;
            setTimeout(() => checkTorchCapability(Quagga.CameraAccess.getActiveTrack()), 800);
            resolve();
          });
        });
      }
    }

    Quagga.onDetected((result) => {
      if (!isQuaggaScanning) return;
      const code = result.codeResult.code;
      if (code === quaggaLastCode) {
        quaggaCodeCount++;
        if (quaggaCodeCount >= REQUIRED_MATCHES) {
          onScanSuccess(code);
        }
      } else {
        quaggaLastCode = code;
        quaggaCodeCount = 1;
      }
    });

    Quagga.onProcessed(function(result) {
      if (!isQuaggaScanning) return;
      var drawingCtx = Quagga.canvas.ctx.overlay,
          drawingCanvas = Quagga.canvas.dom.overlay;
      if (result) {
        if (result.boxes) {
          drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
          result.boxes.filter(box => box !== result.box).forEach(box => {
              Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
          });
        }
        if (result.box) {
          Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
        }
        if (result.codeResult && result.codeResult.code) {
          Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
        }
      }
    });

    async function switchCamera(cameraId) {
      if (!cameraId) return;
      const select = document.getElementById('cameraSelect');
      select.disabled = true;
      document.getElementById('btn-torch').style.display = 'none';
      try {
        await startEngine(cameraId);
      } catch (err) {
        alert(translations[currentLang].alertCamSwitch + '\n' + err);
      } finally {
        select.disabled = false;
      }
    }

    async function startScan(target) {
      currentTarget = target;
      document.getElementById('scanner-container').style.display = 'flex';
      
      const t = translations[currentLang];
      const select = document.getElementById('cameraSelect');
      select.innerHTML = `<option>${t.cameraLoading}</option>`;
      select.disabled  = true;

      try {
        cameras = await Html5Qrcode.getCameras();
      } catch (err) {
        cameras = [];
      }

      if (cameras.length > 0) {
        select.innerHTML = '';
        cameras.forEach((cam, idx) => {
          const opt = document.createElement('option');
          opt.value = cam.id;
          opt.text  = cam.label || `${t.cameraDefault} ${idx + 1}`;
          select.appendChild(opt);
        });
        select.disabled = false;

        const backCam = cameras.find(c => /back|rear|environment|å¾Œ/i.test(c.label));
        const defaultCam = backCam || cameras[cameras.length - 1];
        select.value = defaultCam.id;

        try {
          await startEngine(defaultCam.id);
        } catch (err) {
          alert(t.alertCamFail + '\n' + err);
          await stopScan();
        }
      } else {
        select.innerHTML = `<option value="">${t.cameraDefault} (é è¨­)</option>`;
        try {
          await startEngineFallback();
        } catch (err) {
          alert(t.alertCamFail + '\n' + err);
          await stopScan();
        }
      }
    }

    async function stopScan() {
      document.getElementById('scanner-container').style.display = 'none';
      isTorchOn = false; 
      document.getElementById('btn-torch').classList.remove('active');
      await stopActiveEngines();
    }

    function onScanSuccess(decodedText) {
      if (navigator.vibrate) navigator.vibrate(200);
      stopScan(); 
      
      const extracted = decodedText; 
      if (currentTarget === 'A') {
        document.getElementById('fieldA').value = extracted;
      } else if (currentTarget === 'B') {
        document.getElementById('fieldB').value = extracted;
      }
      checkAutoCompare();
    }

    function clearField(target) {
      if (target === 'A') document.getElementById('fieldA').value = '';
      if (target === 'B') document.getElementById('fieldB').value = '';
    }
    function clearAll() { clearField('A'); clearField('B'); }

    function checkAutoCompare() {
      const mode = document.querySelector('input[name="compareMode"]:checked').value;
      const valA = document.getElementById('fieldA').value;
      const valB = document.getElementById('fieldB').value;
      if (mode === 'auto' && valA !== '' && valB !== '') {
        showCompareResult(valA, valB);
      }
    }

    function manualCompare() {
      const valA = document.getElementById('fieldA').value;
      const valB = document.getElementById('fieldB').value;
      if (!valA || !valB) {
        alert(translations[currentLang].alertEmpty);
        return;
      }
      showCompareResult(valA, valB);
    }

    function showCompareResult(valA, valB) {
      const isMatch = (valA === valB);
      const t = translations[currentLang];
      document.getElementById('modalValA').innerText = valA;
      document.getElementById('modalValB').innerText = valB;
      const el = document.getElementById('modalResult');
      el.innerText  = isMatch ? t.matchSuccess : t.matchFail;
      el.className  = 'result-text ' + (isMatch ? 'match' : 'mismatch');
      document.getElementById('resultModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('resultModal').style.display = 'none';
    }

    window.onload = () => {
      changeLanguage();
      applyScanModeUI();
    };
  </script>
</body>
</html>
